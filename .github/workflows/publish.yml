name: Cli Publish
on:
  repository_dispatch:
    types: [ build ]
  push:
    branches: [ test_branch ]
  workflow_dispatch:
    inputs:
      changeLog:
        description: 'Open API Changelog'
        required: true
      versionType:
        description: 'Major: 0, Minor:1, Patch: 2'
        required: true

jobs:
#   releseCliCore:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: convictional/trigger-workflow-and-wait@v1.3.0
#         with:
#           owner: LakshmiRavali
#           repo: twilio-cli-core
#           github_token: ${{ secrets.REPO_ACCESS_TOKEN }}
#           workflow_file_name: build.yml
#           ref: test_branch_actions
#           wait_interval: 20
#           propagate_failure: true
#           trigger_workflow: true
#           wait_workflow: true
#   releseCliCore:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: felixp8/dispatch-and-wait@v0.1.0
#         with:
#           owner: LakshmiRavali
#           repo: twilio-cli-core
#           token: ${{ secrets.REPO_ACCESS_TOKEN }}
#           event_type: releaseCliCore
#           wait_time: 20
#           max_time: 120
#   build-chain:
#     runs-on: ubuntu-latest
#     steps:
#       - name: "Run build-chain"
#         id: build-chain
#         uses: kiegroup/github-action-build-chain@v2.5
#         with:
#           definition-file: https://raw.githubusercontent.com/LakshmiRavali/twilio-cli-core/main/.github/workflows/build.yml
#           flow-type: single
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [10.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm test
      - run: echo ${{ github.event.inputs.changeLog }}
  updateAPIDefinitionsChangeLog:
     runs-on: ubuntu-latest
     needs: [build]
     steps:
     - uses: actions/checkout@v2
     - name: Update Changelog
       run: |
         bash scripts/updateApiDefinitions.sh ${{ github.event.inputs.changeLog }} ${{ github.event.inputs.versionType }}
  release:
     runs-on: ubuntu-latest
     needs: [updateAPIDefinitionsChangeLog]
     steps:
     - uses: actions/checkout@v2
     - run: git pull
     - run: npm install
     - name: Use Node.js ${{ matrix.node-version }}
       uses: actions/setup-node@v2
       with:
         node-version: ${{ matrix.node-version }}
         cache: 'npm'
     - name: semanticRelease
       run: npm install --save-dev @semantic-release/changelog @semantic-release/git
     - run: npm ci && npx semantic-release -t \${version}
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  updateRelease:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [ 10.x ]
    needs: [ release ]
    steps:
      - uses: actions/checkout@v2
      - run: git fetch --tags
      - name: Getting tag
        id: test
        run: |
          echo "::set-output name=TAG_NAME::$(git describe --tags $(git rev-list --tags --max-count=1))"
      - run: echo "${{steps.test.outputs.TAG_NAME}}"
      - name: update release
        id: update_release
        uses: tubone24/update_release@v1.2.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          TAG_NAME: ${{steps.test.outputs.TAG_NAME}}
        with:
          is_append_body: true
          body: ${{ github.event.inputs.changeLog }}

#   oclifRelease:
#     name: Publish for ${{ matrix.os }}
#     runs-on: ${{ matrix.os }}
#     needs: [build]
#     strategy:
#       fail-fast: false
#       matrix:
#         include:
#           - os: ubuntu-latest
#             artifact_name: deb/twilio_2.27.1-1_amd64.deb
#             asset_name: twilio.deb
#             command_name: sudo oclif-dev pack:deb
#           - os: macos-latest
#             artifact_name: win/twilio-v2.27.1-x86.exe
#             asset_name: twilio.exe
#             command_name: oclif-dev pack:win
#           - os: macos-latest
#             artifact_name: macos/twilio-v2.27.1.pkg
#             asset_name: twilio.pkg
#             command_name: oclif-dev pack:macos

#     steps:
#       - uses: actions/checkout@v2
#       - name: 'Get Previous tag'
#         id: previoustag
#         uses: "WyriHaximus/github-action-get-previous-tag@v1"
#         with:
#           fallback: 2.27.1
#       - run: npm cache clear & npm ci
#       - run: npm install -g @oclif/dev-cli
#       - run: |
#           if [ "$RUNNER_OS" == "macOS" ]; then
#             brew install makensis
#           fi
#       - run: ${{ matrix.command_name }}
#       - name: Upload binaries to release
#         uses: svenstaro/upload-release-action@v2
#         with:
#           repo_token: ${{ secrets.GITHUB_TOKEN }}
#           file: dist/${{ matrix.artifact_name }}
#           asset_name: ${{ matrix.asset_name }}
#           tag: ${{ steps.previoustag.outputs.tag }}
